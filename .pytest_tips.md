# Pytest Testing Tips for CurveEditor

## Current Status
- **Total Tests**: 2275
- **Pass Rate**: 98% (2230 passed, 45 failed)
- **Execution Time**: ~3 minutes for full suite

## Installed Plugins
- `pytest-timeout` - Prevents individual tests from hanging (60s timeout)
- `pytest-qt` - Qt application testing support
- `pytest-cov` - Code coverage reporting
- `pytest-benchmark` - Performance benchmarking
- `pytest-hypothesis` - Property-based testing
- `pytest-pystack` - Stack trace dumping for hanging tests
- `pytest-xdist` - Parallel test execution

## Quick Commands

### Run All Tests
```bash
uv run pytest tests/
```

### Run Specific Test File
```bash
uv run pytest tests/test_core_models.py -v
```

### Run Tests in Parallel (4 workers)
```bash
uv run pytest tests/ -n 4
```

### Show Only Failed Tests
```bash
uv run pytest tests/ --lf  # last failed
uv run pytest tests/ --ff  # failed first, then others
```

### Debug Hanging Tests
```bash
# Show stack traces for tests taking >10s
uv run pytest tests/ --pystack-threshold=10 --pystack-output-file=./debug.log

# Use faulthandler to dump all threads after 30s
uv run pytest tests/ -o faulthandler_timeout=30
```

### Show Slowest Tests
```bash
uv run pytest tests/ --durations=20  # Already enabled in pytest.ini with --durations=10
```

### Coverage Report
```bash
uv run pytest tests/ --cov=. --cov-report=term-missing
```

### Stop at First Failure
```bash
uv run pytest tests/ -x
```

### Verbose Output
```bash
uv run pytest tests/ -vv
```

## Troubleshooting Tips

### Test Suite Seems to Hang
- Full suite needs ~3 minutes - don't kill it too early!
- Use `--durations` to identify slow tests
- Use `--pystack-threshold` to detect actual hangs

### Memory Issues
- Run tests in batches by directory
- Use pytest-xdist to isolate test processes
- Check with `pytest-memray` plugin

### Specific Test Failures
```bash
# Run with full traceback
uv run pytest tests/test_file.py::TestClass::test_method -vv --tb=long

# Enter debugger on failure
uv run pytest tests/test_file.py --pdb

# Start debugger at beginning of test
uv run pytest tests/test_file.py --trace
```

## Best Practices

1. **Don't interrupt the test suite too early** - it takes ~3 minutes
2. **Use `-x` during development** to stop at first failure
3. **Use `--lf`** to rerun only failures after fixing
4. **Check `--durations`** to identify performance bottlenecks
5. **Run parallel with `-n auto`** for faster feedback (but harder to debug)
6. **Use type checking** before running tests: `./bpr --errors-only`

## pytest.ini Configuration

Current settings:
- Timeout: 60s per test (thread-based)
- Auto-show 10 slowest tests
- Qt platform: offscreen (no GUI display)
- Warnings disabled for cleaner output

## Known Issues to Fix
- 45 failing tests (see test output for details)
- Most failures in: StateManager, Timeline, TrackingCommands
